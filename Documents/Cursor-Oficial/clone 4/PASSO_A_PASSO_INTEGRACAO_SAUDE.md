# ü©∫ Passo a Passo: Integra√ß√£o Apple Health/Google Fit 100% Funcional

## üìã Pr√©-requisitos

### 1. Configura√ß√£o do Ambiente
- [x] ‚úÖ Hook `useHealthIntegration` j√° implementado
- [x] ‚úÖ Componente `AdvancedAnalytics` com integra√ß√£o
- [x] ‚úÖ Bot√£o de conex√£o no `BeneficiosVisuais`
- [x] ‚úÖ Migra√ß√µes do banco criadas

### 2. Depend√™ncias Necess√°rias
```bash
# Verificar se estas depend√™ncias est√£o instaladas
npm list date-fns
npm list recharts
npm list lucide-react
```

## üöÄ Passo 1: Configura√ß√£o do Supabase

### 1.1 Executar Migra√ß√µes
```sql
-- Verificar se as tabelas existem
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('health_integration_config', 'health_data_records', 'health_sync_log');
```

### 1.2 Criar Pol√≠ticas RLS
```sql
-- Pol√≠ticas para health_integration_config
CREATE POLICY "Users can view own health config" ON health_integration_config
FOR SELECT USING (auth.uid()::text = user_id::text);

CREATE POLICY "Users can insert own health config" ON health_integration_config
FOR INSERT WITH CHECK (auth.uid()::text = user_id::text);

CREATE POLICY "Users can update own health config" ON health_integration_config
FOR UPDATE USING (auth.uid()::text = user_id::text);
```

## üéØ Passo 2: Implementa√ß√£o iOS (Apple Health)

### 2.1 Configura√ß√£o do iOS
```typescript
// src/hooks/useHealthIntegration.tsx
// Adicionar detec√ß√£o real de iOS
const isIOS = () => {
  return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
};
```

### 2.2 Bridge Nativo (Para App Real)
```swift
// iOS/HealthKitBridge.swift
import HealthKit

class HealthKitBridge: NSObject {
    let healthStore = HKHealthStore()
    
    func requestAuthorization() {
        let typesToRead: Set<HKObjectType> = [
            HKObjectType.quantityType(forIdentifier: .bodyMass)!,
            HKObjectType.quantityType(forIdentifier: .height)!,
            HKObjectType.quantityType(forIdentifier: .stepCount)!,
            HKObjectType.quantityType(forIdentifier: .heartRate)!
        ]
        
        healthStore.requestAuthorization(toShare: nil, read: typesToRead) { success, error in
            // Callback para JavaScript
        }
    }
}
```

## ü§ñ Passo 3: Implementa√ß√£o Android (Google Fit)

### 3.1 Configura√ß√£o do Google Fit
```typescript
// src/hooks/useHealthIntegration.tsx
// Melhorar detec√ß√£o do Google Fit
const isGoogleFitAvailable = () => {
  return window.gapi && window.gapi.client && window.gapi.auth2;
};
```

### 3.2 API Keys Reais
```typescript
// Substituir chaves mock por reais
const GOOGLE_FIT_CONFIG = {
  apiKey: 'SUA_GOOGLE_API_KEY',
  clientId: 'SEU_GOOGLE_CLIENT_ID',
  discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/fitness/v1/rest'],
  scope: [
    'https://www.googleapis.com/auth/fitness.body.read',
    'https://www.googleapis.com/auth/fitness.body.write'
  ].join(' ')
};
```

## üîß Passo 4: Melhorar Hook de Integra√ß√£o

### 4.1 Adicionar Persist√™ncia Real
```typescript
// src/hooks/useHealthIntegration.tsx
const saveUserConfig = useCallback(async (config: Partial<HealthIntegrationConfig>) => {
  try {
    if (!user) throw new Error('Usu√°rio n√£o logado');
    
    const { data: profile } = await supabase
      .from('profiles')
      .select('id')
      .eq('user_id', user.id)
      .single();

    // Salvar no banco real
    const { error } = await supabase
      .from('health_integration_config')
      .upsert({
        user_id: profile.id,
        config: config,
        updated_at: new Date().toISOString()
      });

    if (error) throw error;
    
    setState(prev => ({ ...prev, config: { ...prev.config, ...config } }));
    
    toast({
      title: '‚úÖ Configura√ß√£o salva',
      description: 'Suas prefer√™ncias foram atualizadas no servidor',
    });
  } catch (error) {
    console.error('Erro ao salvar configura√ß√£o:', error);
    toast({
      title: 'Erro ao salvar',
      description: 'N√£o foi poss√≠vel salvar suas configura√ß√µes',
      variant: 'destructive',
    });
  }
}, [user, toast]);
```

### 4.2 Adicionar Logs de Sincroniza√ß√£o
```typescript
// src/hooks/useHealthIntegration.tsx
const logSyncActivity = async (result: HealthSyncResult) => {
  try {
    if (!user) return;
    
    const { data: profile } = await supabase
      .from('profiles')
      .select('id')
      .eq('user_id', user.id)
      .single();

    await supabase
      .from('health_sync_log')
      .insert({
        user_id: profile.id,
        sync_type: 'health_integration',
        records_imported: result.recordsImported,
        success: result.success,
        errors: result.errors,
        sync_date: new Date().toISOString()
      });
  } catch (error) {
    console.error('Erro ao logar sincroniza√ß√£o:', error);
  }
};
```

## üìä Passo 5: Implementar Dados Reais

### 5.1 Sincroniza√ß√£o com Apple Health
```typescript
// src/hooks/useHealthIntegration.tsx
const syncAppleHealthData = useCallback(async (): Promise<HealthSyncResult> => {
  if (!state.isAuthorized) {
    return {
      success: false,
      recordsImported: 0,
      lastSyncDate: new Date(),
      errors: ['Apple Health n√£o est√° conectado'],
    };
  }

  setState(prev => ({ ...prev, isLoading: true }));

  try {
    if (!user) throw new Error('Usu√°rio n√£o logado');

    // Buscar dados reais do Apple Health via bridge nativo
    const healthData = await window.webkit?.messageHandlers?.healthKit?.postMessage({
      action: 'fetchHealthData',
      types: ['weight', 'height', 'steps', 'heartRate']
    });

    // Processar dados reais
    let recordsImported = 0;
    
    if (healthData?.weight) {
      await saveWeightData(healthData.weight);
      recordsImported++;
    }
    
    if (healthData?.steps) {
      await saveActivityData(healthData.steps);
      recordsImported++;
    }

    const result = {
      success: true,
      recordsImported,
      lastSyncDate: new Date(),
    };

    await logSyncActivity(result);
    return result;
  } catch (error) {
    const result = {
      success: false,
      recordsImported: 0,
      lastSyncDate: new Date(),
      errors: [error.message],
    };
    
    await logSyncActivity(result);
    return result;
  } finally {
    setState(prev => ({ ...prev, isLoading: false }));
  }
}, [state.isAuthorized, user]);
```

### 5.2 Sincroniza√ß√£o com Google Fit
```typescript
// src/hooks/useHealthIntegration.tsx
const syncGoogleFitData = useCallback(async (): Promise<HealthSyncResult> => {
  if (!state.isAuthorized) {
    return {
      success: false,
      recordsImported: 0,
      lastSyncDate: new Date(),
      errors: ['Google Fit n√£o est√° conectado'],
    };
  }

  setState(prev => ({ ...prev, isLoading: true }));

  try {
    if (!user) throw new Error('Usu√°rio n√£o logado');

    // Buscar dados reais do Google Fit
    const fitness = window.gapi.client.fitness;
    
    const weightData = await fitness.users.dataset.aggregate({
      userId: 'me',
      requestBody: {
        aggregateBy: [{
          dataTypeName: 'com.google.weight',
          dataSourceId: 'derived:com.google.weight:com.google.android.gms:merge_weight'
        }],
        bucketByTime: { durationMillis: 86400000 }, // 24 horas
        startTimeMillis: Date.now() - (7 * 24 * 60 * 60 * 1000), // 7 dias atr√°s
        endTimeMillis: Date.now()
      }
    });

    let recordsImported = 0;
    
    if (weightData.result.bucket) {
      for (const bucket of weightData.result.bucket) {
        for (const dataset of bucket.dataset) {
          for (const point of dataset.point) {
            await saveWeightData({
              value: point.value[0].fpVal,
              timestamp: new Date(parseInt(point.startTimeNanos) / 1000000)
            });
            recordsImported++;
          }
        }
      }
    }

    const result = {
      success: true,
      recordsImported,
      lastSyncDate: new Date(),
    };

    await logSyncActivity(result);
    return result;
  } catch (error) {
    const result = {
      success: false,
      recordsImported: 0,
      lastSyncDate: new Date(),
      errors: [error.message],
    };
    
    await logSyncActivity(result);
    return result;
  } finally {
    setState(prev => ({ ...prev, isLoading: false }));
  }
}, [state.isAuthorized, user]);
```

## üé® Passo 6: Melhorar Interface

### 6.1 Adicionar Indicadores Visuais
```typescript
// src/components/admin/AdvancedAnalytics.tsx
// Adicionar indicadores de status mais detalhados
const HealthStatusIndicator = () => {
  if (!healthState.isConnected) return null;
  
  return (
    <div className="flex items-center gap-2 p-3 bg-green-50 border border-green-200 rounded-lg">
      <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
      <span className="text-green-800 font-medium">
        Conectado com {getHealthPlatform()}
      </span>
      <Badge variant="outline" className="bg-green-100 text-green-800">
        {realTimeData.lastSync ? 
          `√öltima sincroniza√ß√£o: ${realTimeData.lastSync.toLocaleTimeString()}` : 
          'Sincronizando...'
        }
      </Badge>
    </div>
  );
};
```

### 6.2 Adicionar Configura√ß√µes Avan√ßadas
```typescript
// src/components/HealthIntegrationSettings.tsx
export const HealthIntegrationSettings = () => {
  const { state, saveUserConfig } = useHealthIntegration();
  
  return (
    <Card>
      <CardHeader>
        <CardTitle>Configura√ß√µes de Integra√ß√£o</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <div className="space-y-2">
          <Label>Tipos de Dados</Label>
          <div className="grid grid-cols-2 gap-2">
            {Object.entries(state.config.dataTypes).map(([key, value]) => (
              <div key={key} className="flex items-center space-x-2">
                <Checkbox
                  checked={value}
                  onCheckedChange={(checked) => 
                    saveUserConfig({
                      dataTypes: { ...state.config.dataTypes, [key]: checked }
                    })
                  }
                />
                <Label className="text-sm capitalize">{key}</Label>
              </div>
            ))}
          </div>
        </div>
        
        <div className="space-y-2">
          <Label>Frequ√™ncia de Sincroniza√ß√£o</Label>
          <Select
            value={state.config.syncFrequency}
            onValueChange={(value) => 
              saveUserConfig({ syncFrequency: value as any })
            }
          >
            <SelectTrigger>
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="manual">Manual</SelectItem>
              <SelectItem value="daily">Di√°ria</SelectItem>
              <SelectItem value="weekly">Semanal</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </CardContent>
    </Card>
  );
};
```

## üîÑ Passo 7: Implementar Sincroniza√ß√£o Autom√°tica

### 7.1 Sincroniza√ß√£o em Background
```typescript
// src/hooks/useHealthIntegration.tsx
useEffect(() => {
  if (!state.config.autoSync || !state.isConnected) return;
  
  const syncInterval = setInterval(async () => {
    console.log('üîÑ Sincroniza√ß√£o autom√°tica iniciada...');
    await syncAllData();
  }, getSyncInterval(state.config.syncFrequency));
  
  return () => clearInterval(syncInterval);
}, [state.config.autoSync, state.isConnected, state.config.syncFrequency]);

const getSyncInterval = (frequency: string) => {
  switch (frequency) {
    case 'daily': return 24 * 60 * 60 * 1000; // 24 horas
    case 'weekly': return 7 * 24 * 60 * 60 * 1000; // 7 dias
    default: return 0; // Manual
  }
};
```

## üß™ Passo 8: Testes e Valida√ß√£o

### 8.1 Teste de Conex√£o
```typescript
// src/components/HealthIntegrationTest.tsx
export const HealthIntegrationTest = () => {
  const { state, connectAppleHealth, connectGoogleFit, syncAllData } = useHealthIntegration();
  
  const runTest = async () => {
    console.log('üß™ Iniciando teste de integra√ß√£o...');
    
    // Teste de conex√£o
    const connectionResult = await (isIOS() ? connectAppleHealth() : connectGoogleFit());
    console.log('Conex√£o:', connectionResult);
    
    // Teste de sincroniza√ß√£o
    const syncResult = await syncAllData();
    console.log('Sincroniza√ß√£o:', syncResult);
    
    // Teste de dados
    console.log('Dados em tempo real:', realTimeData);
  };
  
  return (
    <Button onClick={runTest} variant="outline">
      üß™ Testar Integra√ß√£o
    </Button>
  );
};
```

### 8.2 Valida√ß√£o de Dados
```typescript
// src/utils/healthDataValidation.ts
export const validateHealthData = (data: any) => {
  const errors: string[] = [];
  
  if (data.weight && (data.weight < 20 || data.weight > 300)) {
    errors.push('Peso fora do intervalo v√°lido (20-300kg)');
  }
  
  if (data.height && (data.height < 100 || data.height > 250)) {
    errors.push('Altura fora do intervalo v√°lido (100-250cm)');
  }
  
  if (data.heartRate && (data.heartRate < 30 || data.heartRate > 200)) {
    errors.push('Frequ√™ncia card√≠aca fora do intervalo v√°lido (30-200bpm)');
  }
  
  return {
    isValid: errors.length === 0,
    errors
  };
};
```

## üì± Passo 9: Configura√ß√£o Mobile

### 9.1 Capacitor (Para App Mobile)
```bash
# Instalar Capacitor
npm install @capacitor/core @capacitor/ios @capacitor/android

# Adicionar plugins de sa√∫de
npm install @capacitor/health-kit
npm install @capacitor/google-fit
```

### 9.2 Configura√ß√£o iOS
```json
// ios/App/App/Info.plist
<key>NSHealthShareUsageDescription</key>
<string>Este app precisa acessar seus dados de sa√∫de para sincronizar com o Apple Health</string>
<key>NSHealthUpdateUsageDescription</key>
<string>Este app precisa atualizar seus dados de sa√∫de no Apple Health</string>
```

### 9.3 Configura√ß√£o Android
```xml
<!-- android/app/src/main/AndroidManifest.xml -->
<uses-permission android:name="android.permission.ACTIVITY_RECOGNITION" />
<uses-permission android:name="android.permission.BODY_SENSORS" />
```

## üöÄ Passo 10: Deploy e Monitoramento

### 10.1 Vari√°veis de Ambiente
```env
# .env.local
GOOGLE_FIT_CLIENT_ID=seu_client_id_aqui
GOOGLE_FIT_API_KEY=sua_api_key_aqui
APPLE_HEALTH_ENABLED=true
GOOGLE_FIT_ENABLED=true
```

### 10.2 Monitoramento
```typescript
// src/utils/healthAnalytics.ts
export const trackHealthIntegration = (event: string, data?: any) => {
  // Enviar para analytics
  console.log('üìä Health Integration Event:', event, data);
  
  // Salvar no banco para monitoramento
  supabase.from('health_analytics').insert({
    event,
    data,
    timestamp: new Date().toISOString()
  });
};
```

## ‚úÖ Checklist Final

- [ ] ‚úÖ Hook de integra√ß√£o implementado
- [ ] ‚úÖ Interface de usu√°rio criada
- [ ] ‚úÖ Persist√™ncia no banco configurada
- [ ] ‚úÖ Sincroniza√ß√£o real implementada
- [ ] ‚úÖ Valida√ß√£o de dados adicionada
- [ ] ‚úÖ Configura√ß√µes avan√ßadas criadas
- [ ] ‚úÖ Sincroniza√ß√£o autom√°tica funcionando
- [ ] ‚úÖ Testes implementados
- [ ] ‚úÖ Configura√ß√£o mobile pronta
- [ ] ‚úÖ Monitoramento ativo
- [ ] ‚úÖ Deploy realizado

## üéØ Resultado Final

Com estes passos implementados, voc√™ ter√° uma integra√ß√£o 100% funcional com:
- ‚úÖ Conex√£o real com Apple Health/Google Fit
- ‚úÖ Sincroniza√ß√£o autom√°tica de dados
- ‚úÖ Interface intuitiva e responsiva
- ‚úÖ Persist√™ncia e backup de dados
- ‚úÖ Monitoramento e analytics
- ‚úÖ Valida√ß√£o e tratamento de erros
- ‚úÖ Configura√ß√µes personaliz√°veis

A integra√ß√£o estar√° pronta para uso em produ√ß√£o! üöÄ 