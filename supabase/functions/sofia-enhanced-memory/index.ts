import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

Deno.serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
    const supabase = createClient(supabaseUrl, supabaseServiceKey);
    
    const { message, userId, context } = await req.json();

    console.log('üß† Sofia Enhanced Memory - Processando mensagem para usu√°rio:', userId);

    // 1. Buscar perfil do usu√°rio (primeiro nome)
    let firstName = 'usu√°rio';
    let userProfile = null;
    
    // Tentar buscar primeiro na tabela profiles
    const { data: profileData } = await supabase
      .from('profiles')
      .select('full_name, email')
      .eq('user_id', userId)
      .single();
      
    if (profileData?.full_name) {
      firstName = profileData.full_name.split(' ')[0];
      userProfile = profileData;
      console.log('üë§ Usu√°rio encontrado no profiles:', firstName);
    } else {
      // Se n√£o encontrou no profiles, buscar no auth.users
      console.log('üìã Perfil n√£o encontrado em profiles, buscando em auth.users');
      const { data: authUser } = await supabase.auth.admin.getUserById(userId);
      if (authUser?.user?.email) {
        // Extrair nome do email ou usar dados do metadata
        const emailName = authUser.user.email.split('@')[0];
        firstName = authUser.user.user_metadata?.full_name?.split(' ')[0] || 
                   authUser.user.user_metadata?.first_name ||
                   emailName || 'usu√°rio';
        userProfile = {
          email: authUser.user.email,
          full_name: authUser.user.user_metadata?.full_name || firstName
        };
        console.log('üë§ Usu√°rio encontrado no auth.users:', firstName);
      }
    }

    // 2. BUSCAR TODOS OS DADOS DO USU√ÅRIO - ACESSO COMPLETO
    console.log('üìä Carregando TODOS os dados do usu√°rio...');
    
    // Anamnese m√©dica completa
    const { data: anamnesis } = await supabase
      .from('user_anamnesis')
      .select('*')
      .eq('user_id', userId)
      .single();

    // Dados f√≠sicos e pesagens
    const { data: physicalData } = await supabase
      .from('user_physical_data')
      .select('*')
      .eq('user_id', userId)
      .single();

    const { data: weightMeasurements } = await supabase
      .from('weight_measurements')
      .select('*')
      .eq('user_id', userId)
      .order('measurement_date', { ascending: false })
      .limit(20);

    // Nutri√ß√£o e alimenta√ß√£o
    const { data: nutritionTracking } = await supabase
      .from('nutrition_tracking')
      .select('*')
      .eq('user_id', userId)
      .order('date', { ascending: false })
      .limit(30);

    const { data: nutritionGoals } = await supabase
      .from('nutrition_goals')
      .select('*')
      .eq('user_id', userId);

    const { data: foodAnalysis } = await supabase
      .from('food_analysis')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false })
      .limit(20);

    // Exerc√≠cios e atividade f√≠sica
    const { data: exerciseTracking } = await supabase
      .from('exercise_tracking')
      .select('*')
      .eq('user_id', userId)
      .order('date', { ascending: false })
      .limit(20);

    // Hidrata√ß√£o e sono
    const { data: waterTracking } = await supabase
      .from('water_tracking')
      .select('*')
      .eq('user_id', userId)
      .order('date', { ascending: false })
      .limit(20);

    const { data: sleepTracking } = await supabase
      .from('sleep_tracking')
      .select('*')
      .eq('user_id', userId)
      .order('date', { ascending: false })
      .limit(20);

    // Humor e bem-estar
    const { data: moodTracking } = await supabase
      .from('mood_tracking')
      .select('*')
      .eq('user_id', userId)
      .order('date', { ascending: false })
      .limit(20);

    const { data: dailyAdvancedTracking } = await supabase
      .from('daily_advanced_tracking')
      .select('*')
      .eq('user_id', userId)
      .order('date', { ascending: false })
      .limit(20);

    // Metas e objetivos
    const { data: userGoals } = await supabase
      .from('user_goals')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false });

    const { data: goalProgressLogs } = await supabase
      .from('goal_progress_logs')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false })
      .limit(20);

    // Miss√µes e desafios
    const { data: dailyMissions } = await supabase
      .from('daily_mission_sessions')
      .select('*')
      .eq('user_id', userId)
      .order('date', { ascending: false })
      .limit(20);

    const { data: dailyResponses } = await supabase
      .from('daily_responses')
      .select('*')
      .eq('user_id', userId)
      .order('date', { ascending: false })
      .limit(30);

    const { data: challengeParticipations } = await supabase
      .from('challenge_participations')
      .select('*')
      .eq('user_id', userId);

    // üìö BUSCAR BASE DE CONHECIMENTO DA EMPRESA - INSTITUTO DOS SONHOS
    const { data: companyKnowledge } = await supabase
      .from('company_knowledge_base')
      .select('category, title, content')
      .eq('is_active', true)
      .order('priority', { ascending: false });

    // An√°lises e relat√≥rios
    const { data: weeklyAnalyses } = await supabase
      .from('weekly_analyses')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false })
      .limit(10);

    const { data: medicalReports } = await supabase
      .from('medical_reports')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false })
      .limit(10);

    // Medicamentos e suplementos
    const { data: prescriptions } = await supabase
      .from('prescriptions')
      .select('*')
      .eq('user_id', userId);

    const { data: userSupplements } = await supabase
      .from('user_supplements')
      .select('*')
      .eq('user_id', userId);

    // Integra√ß√µes e dispositivos
    const { data: heartRateData } = await supabase
      .from('heart_rate_data')
      .select('*')
      .eq('user_id', userId)
      .order('recorded_at', { ascending: false })
      .limit(20);

    // Documentos m√©dicos
    const { data: medicalDocuments } = await supabase
      .from('medical_documents')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false })
      .limit(10);

    // Educa√ß√£o e cursos
    const { data: courseProgress } = await supabase
      .from('course_progress')
      .select('*')
      .eq('user_id', userId);

    // Comunidade e social
    const { data: healthFeedPosts } = await supabase
      .from('health_feed_posts')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false })
      .limit(10);

    // Conversas recentes (mantido)
    const { data: recentConversations } = await supabase
      .from('user_conversations')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false })
      .limit(10);

    console.log('üìä DADOS COLETADOS:');
    console.log('- Anamnese:', !!anamnesis);
    console.log('- Dados f√≠sicos:', !!physicalData);
    console.log('- Pesagens:', weightMeasurements?.length || 0);
    console.log('- Nutri√ß√£o tracking:', nutritionTracking?.length || 0);
    console.log('- An√°lises de comida:', foodAnalysis?.length || 0);
    console.log('- Exerc√≠cios:', exerciseTracking?.length || 0);
    console.log('- Hidrata√ß√£o:', waterTracking?.length || 0);
    console.log('- Sono:', sleepTracking?.length || 0);
    console.log('- Humor:', moodTracking?.length || 0);
    console.log('- Metas:', userGoals?.length || 0);
    console.log('- Miss√µes:', dailyMissions?.length || 0);
    console.log('- Conversas:', recentConversations?.length || 0);

    // 4. Construir contexto COMPLETO para IA
    const contextForAI = {
      userProfile: { firstName, fullProfile: userProfile },
      
      // Anamnese e dados m√©dicos
      anamnesis: anamnesis || null,
      physicalData: physicalData || null,
      
      // Hist√≥rico de peso e medi√ß√µes
      weightHistory: weightMeasurements || [],
      currentWeight: weightMeasurements?.[0]?.peso_kg || null,
      weightTrend: weightMeasurements?.slice(0, 5) || [],
      
      // Dados nutricionais completos
      nutritionTracking: nutritionTracking || [],
      nutritionGoals: nutritionGoals || [],
      foodAnalysis: foodAnalysis || [],
      
      // Atividade f√≠sica
      exerciseHistory: exerciseTracking || [],
      
      // Bem-estar e sa√∫de mental
      waterTracking: waterTracking || [],
      sleepTracking: sleepTracking || [],
      moodTracking: moodTracking || [],
      dailyAdvancedTracking: dailyAdvancedTracking || [],
      
      // Metas e progresso
      userGoals: userGoals || [],
      goalProgress: goalProgressLogs || [],
      
      // Engajamento e motiva√ß√£o
      dailyMissions: dailyMissions || [],
      dailyResponses: dailyResponses || [],
      challengeParticipations: challengeParticipations || [],
      
      // Relat√≥rios e an√°lises
      weeklyAnalyses: weeklyAnalyses || [],
      medicalReports: medicalReports || [],
      
      // Medicamentos e tratamentos
      prescriptions: prescriptions || [],
      supplements: userSupplements || [],
      
      // Dados de dispositivos
      heartRateData: heartRateData || [],
      
      // Documentos e exames
      medicalDocuments: medicalDocuments || [],
      
      // Educa√ß√£o e desenvolvimento
      courseProgress: courseProgress || [],
      
      // Comunidade
      socialPosts: healthFeedPosts || [],
      
      // Conversas
      recentConversations: recentConversations || [],
      currentContext: context || {},
      
      // Base de conhecimento da empresa
      companyKnowledge: companyKnowledge || [],
    };

    // 5. Gerar resposta da IA
    const systemPrompt = buildSystemPrompt(contextForAI);
    console.log('ü§ñ Gerando resposta da IA...');
    
    let response = '';
    let apiUsed = 'none';

    // OpenAI GPT-4o como provedor principal
    const openaiApiKey = Deno.env.get('OPENAI_API_KEY');
    if (openaiApiKey) {
      try {
        console.log('ü§ñ Sofia usando OpenAI GPT-4o...');
        const openaiResponse = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${openaiApiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'gpt-4o',
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: message }
            ],
            temperature: 0.7,
            max_tokens: 120
          })
        });

        const data = await openaiResponse.json();
        if (data?.error) {
          console.error('‚ùå Erro OpenAI:', data.error);
        } else if (data?.choices?.[0]?.message?.content) {
          response = data.choices[0].message.content;
          apiUsed = 'openai-gpt-4o';
          console.log('‚úÖ OpenAI funcionou!');
        }
      } catch (error) {
        console.error('‚ùå Erro OpenAI:', error);
      }
    } else {
      console.warn('OPENAI_API_KEY ausente nas secrets do projeto');
    }

    // Fallback para Google AI se OpenAI falhar
    if (!response) {
      const googleApiKey = Deno.env.get('GOOGLE_AI_API_KEY');
      if (googleApiKey) {
        try {
          console.log('ü§ñ Sofia usando Google AI...');
          const googleResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${googleApiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [{ text: `${systemPrompt}\n\nUsu√°rio: ${message}` }]
              }],
              generationConfig: { 
                temperature: 0.9, 
                maxOutputTokens: 120,
                topP: 0.8,
                topK: 10
              }
            })
          });

          if (!googleResponse.ok) {
            console.error('‚ùå Erro Google AI: Error:', googleResponse.status);
            throw new Error(`Google AI error: ${googleResponse.status}`);
          }

          const gData = await googleResponse.json();
          if (gData?.candidates?.[0]?.content?.parts?.[0]?.text) {
            response = gData.candidates[0].content.parts[0].text;
            apiUsed = 'google-ai';
            console.log('‚úÖ Google AI funcionou!');
          } else {
            console.log('‚ö†Ô∏è Google AI retornou resposta vazia');
          }
        } catch (error) {
          console.error('‚ùå Erro Google AI:', error);
        }
      } else {
        console.warn('GOOGLE_AI_API_KEY ausente nas secrets do projeto');
      }
    }

    // Resposta padr√£o se nenhuma IA funcionar
    if (!response || response.includes('problema t√©cnico')) {
      response = `Ol√° ${firstName}! Sou a Sofia, sua assistente de sa√∫de. Como posso ajudar voc√™ hoje? üíö`;
      apiUsed = 'fallback';
    }

    console.log('‚úÖ Resposta gerada usando:', apiUsed);

    // 5. Salvar conversa
    console.log('üíæ Salvando conversa para usu√°rio:', userId);
    const { error: saveError } = await supabase
      .from('user_conversations')
      .insert([
        {
          user_id: userId,
          conversation_id: `conversation_${Date.now()}`,
          message_role: 'user',
          message_content: message,
          timestamp: new Date().toISOString(),
          session_metadata: context || {},
          analysis_type: context?.imageUrl ? 'image_analysis' : 'text_chat',
          context: { api_used: apiUsed }
        },
        {
          user_id: userId,
          conversation_id: `conversation_${Date.now()}`,
          message_role: 'assistant',
          message_content: response,
          timestamp: new Date().toISOString(),
          session_metadata: context || {},
          analysis_type: context?.imageUrl ? 'image_analysis' : 'text_chat',
          context: { api_used: apiUsed }
        }
      ]);
      
    if (saveError) {
      console.error('‚ùå Erro ao salvar conversa:', saveError);
    } else {
      console.log('‚úÖ Conversa salva com sucesso');
    }

    // 6. Retornar resposta
    console.log('üéØ Sofia respondendo para:', firstName);

    return new Response(
      JSON.stringify({
        message: response,
        memory_updated: true,
        knowledge_used: [null, null, null, null, null, null],
        context_analyzed: {
          userKnowledge: [
            {
              category: "mental_health",
              title: "Mantendo a Motiva√ß√£o",
              content: "Para manter a motiva√ß√£o: 1) Defina metas pequenas e alcan√ß√°veis, 2) Celebre pequenas vit√≥rias, 3) Encontre um parceiro de treino, 4) Varie suas atividades, 5) Mantenha um di√°rio de progresso.",
              relevance: 0.3
            },
            {
              category: "nutrition",
              title: "Perda de Peso Saud√°vel",
              content: "Para perder peso de forma saud√°vel, foque em: 1) D√©ficit cal√≥rico moderado (300-500 kcal), 2) Prote√≠na adequada (1.6-2.2g/kg), 3) Exerc√≠cio regular, 4) Sono de qualidade, 5) Hidrata√ß√£o adequada. Evite dietas muito restritivas.",
              relevance: 0.3
            },
            {
              category: "nutrition",
              title: "Ganho de Massa Muscular",
              content: "Para ganhar massa muscular: 1) Super√°vit cal√≥rico (200-300 kcal), 2) Prote√≠na alta (1.8-2.4g/kg), 3) Treino de for√ßa progressivo, 4) Descanso adequado, 5) Carboidratos para energia.",
              relevance: 0.3
            },
            {
              category: "exercise",
              title: "Exerc√≠cio Cardiovascular",
              content: "Benef√≠cios do cardio: 1) Melhora sa√∫de card√≠aca, 2) Aumenta resist√™ncia, 3) Queima calorias, 4) Reduz estresse, 5) Melhora sono. Recomendado: 150 min/semana de intensidade moderada.",
              relevance: 0.3
            },
            {
              category: "exercise",
              title: "Treino de For√ßa",
              content: "Benef√≠cios do treino de for√ßa: 1) Aumenta massa muscular, 2) Fortalece ossos, 3) Melhora postura, 4) Acelera metabolismo, 5) Previne les√µes. Recomendado: 2-3x/semana.",
              relevance: 0.3
            },
            {
              category: "mental_health",
              title: "Gerenciando Estresse",
              content: "Para gerenciar estresse: 1) Exerc√≠cio regular, 2) T√©cnicas de respira√ß√£o, 3) Sono adequado, 4) Alimenta√ß√£o balanceada, 5) Atividades relaxantes (medita√ß√£o, yoga).",
              relevance: 0.3
            }
          ],
          recentConversations: [],
          currentContext: context || {},
          conversationHistory: []
        },
        api_used: apiUsed
      }),
      {
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      }
    );

  } catch (error) {
    console.error('‚ùå Erro na fun√ß√£o sofia-enhanced-memory:', error);
    return new Response(
      JSON.stringify({ 
        error: error.message,
        message: 'Ol√°! Sou a Sofia. No momento estou com dificuldades para acessar minhas capacidades de IA, mas estou aqui para ajudar. Pode me contar mais sobre o que voc√™ precisa?'
      }),
      {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      }
    );
  }
});

function buildSystemPrompt(context: any): string {
  const firstName = context.userProfile?.firstName || 'amor';
  
  // Criar contexto da empresa
  let companyContext = '';
  if (context.companyKnowledge && context.companyKnowledge.length > 0) {
    companyContext = `

üìã INSTITUTO DOS SONHOS - CONHECIMENTO COMPLETO:
${context.companyKnowledge.map((item: any) => `
üí° ${item.category.toUpperCase()}: ${item.title}
${item.content}
`).join('\n')}

üè¢ CONTEXTO INSTITUCIONAL:
- Fundado por Rafael Ferreira e Sirlene Freitas
- Especializa√ß√£o em transforma√ß√£o integral (f√≠sica + emocional)
- Equipe multidisciplinar completa
- Atendimento humanizado e personalizado
- M√©todos cient√≠ficos comprovados`;
  }
  
  return `Voc√™ √© Sofia, uma nutricionista carinhosa e emp√°tica do Instituto dos Sonhos! üíö
${companyContext}

üåü PERSONALIDADE:
- SUPER amorosa, carinhosa e humana
- Use emojis em TODAS as mensagens
- Seja como uma amiga querida que se importa de verdade
- Demonstre empatia genu√≠na e alegria ao ajudar

üíñ SEMPRE chame de: ${firstName}

üìã DADOS COMPLETOS DO USU√ÅRIO:
${JSON.stringify({
  perfil: context.userProfile?.fullProfile || {},
  anamnese: context.anamnesis ? 'Completa' : 'Pendente',
  pesoAtual: context.currentWeight || 'N√£o informado',
  tendenciaPeso: context.weightTrend?.length ? 'Com hist√≥rico' : 'Sem dados',
  metasAtivas: context.userGoals?.filter((g: any) => g.status === 'ativa')?.length || 0,
  ultimaRefeicao: context.foodAnalysis?.[0]?.total_calories || 'N√£o registrada',
  exercicioRecente: context.exerciseHistory?.length ? 'Ativo' : 'Sem registros',
  sono: context.sleepTracking?.[0]?.hours_slept || 'N√£o monitorado',
  humor: context.moodTracking?.[0]?.mood_score || 'N√£o avaliado',
  medicamentos: context.prescriptions?.length || 0,
  suplementos: context.supplements?.length || 0,
  completudeDados: Math.round(([
    context.anamnesis, context.physicalData, context.weightHistory?.length,
    context.nutritionTracking?.length, context.exerciseHistory?.length
  ].filter(Boolean).length / 5) * 100)
}, null, 2)}

üí¨ √öLTIMAS CONVERSAS:
${context.recentConversations.slice(-3).map((c: any) => `${c.message_role}: ${c.message_content?.substring(0, 100)}...`).join('\n')}

üçé NUTRI√á√ÉO RECENTE:
${context.foodAnalysis.slice(-3).map((h: any) => `${h.analysis_date}: ${h.total_calories || 0}kcal`).join(' | ')}

üéØ REGRAS DE OURO:
- M√ÅXIMO 2-3 frases curtas
- Use emojis sempre! 
- Seja calorosa e acolhedora
- Lembre do que ${firstName} j√° conversou
- Incentive sempre com carinho
- Se for sobre sa√∫de s√©ria, sugira m√©dico com cuidado

üíù Voc√™ AMA ajudar ${firstName} e demonstra isso!`;
}