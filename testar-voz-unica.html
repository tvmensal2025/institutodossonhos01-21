<!DOCTYPE html>
<html>
<head>
    <title>Teste Voz √önica - Sofia</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
        }
        .log {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Teste Voz √önica - Sofia</h1>
        <p>Teste para verificar se h√° apenas uma voz falando por vez.</p>
        
        <div class="status">
            <strong>Status:</strong> <span id="status">Pronto</span>
        </div>
        
        <button onclick="testarGoogleTTS()">Testar Google TTS</button>
        <button onclick="testarWebSpeech()">Testar Web Speech</button>
        <button onclick="pararTodas()">üõë Parar Todas</button>
        <button onclick="limparLog()">Limpar Log</button>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        let audioElement = null;
        let isSpeaking = false;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }

        function pararTodas() {
            log('üõë Parando todas as vozes...');
            
            // Parar √°udio do Google TTS
            if (audioElement) {
                audioElement.pause();
                audioElement.currentTime = 0;
                audioElement.src = '';
                audioElement = null;
                log('üõë √Åudio do Google TTS parado');
            }
            
            // Parar Web Speech API
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                window.speechSynthesis.stop();
                log('üõë Web Speech API parado');
            }
            
            isSpeaking = false;
            updateStatus('Parado');
            log('‚úÖ Todas as vozes paradas');
        }

        async function testarGoogleTTS() {
            if (isSpeaking) {
                log('‚ö†Ô∏è J√° est√° falando, parando primeiro...');
                pararTodas();
                await new Promise(resolve => setTimeout(resolve, 200));
            }

            const apiKey = 'AIzaSyBB1_I1XIfM9eXXdPaYV1FQys_6viFoXAs';
            const text = 'Ol√°! Sou a Sofia, sua nutricionista virtual. Testando Google TTS.';
            
            log('üé§ Iniciando Google TTS...');
            updateStatus('Falando (Google TTS)');
            isSpeaking = true;

            try {
                const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        input: { text: text },
                        voice: {
                            languageCode: 'pt-BR',
                            name: 'pt-BR-Neural2-C',
                            ssmlGender: 'FEMALE'
                        },
                        audioConfig: {
                            audioEncoding: 'MP3',
                            speakingRate: 0.85,
                            pitch: 1.3,
                            volumeGainDb: 1.2,
                            effectsProfileId: ['headphone-class-device']
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const audioContent = data.audioContent;
                const audioBlob = new Blob(
                    [Uint8Array.from(atob(audioContent), c => c.charCodeAt(0))],
                    { type: 'audio/mp3' }
                );

                const audioUrl = URL.createObjectURL(audioBlob);
                audioElement = new Audio(audioUrl);
                
                audioElement.onended = () => {
                    log('‚úÖ Google TTS terminou');
                    isSpeaking = false;
                    updateStatus('Pronto');
                };
                
                audioElement.onerror = (error) => {
                    log('‚ùå Erro no Google TTS: ' + error);
                    isSpeaking = false;
                    updateStatus('Erro');
                };

                await audioElement.play();
                log('‚úÖ Google TTS iniciado com sucesso');

            } catch (error) {
                log('‚ùå Erro no Google TTS: ' + error.message);
                isSpeaking = false;
                updateStatus('Erro');
            }
        }

        function testarWebSpeech() {
            if (isSpeaking) {
                log('‚ö†Ô∏è J√° est√° falando, parando primeiro...');
                pararTodas();
                setTimeout(() => {
                    iniciarWebSpeech();
                }, 200);
                return;
            }

            iniciarWebSpeech();
        }

        function iniciarWebSpeech() {
            if (!('speechSynthesis' in window)) {
                log('‚ùå Web Speech API n√£o suportada');
                return;
            }

            const text = 'Ol√°! Sou a Sofia, sua nutricionista virtual. Testando Web Speech API.';
            
            log('üé§ Iniciando Web Speech API...');
            updateStatus('Falando (Web Speech)');
            isSpeaking = true;

            // Parar qualquer s√≠ntese anterior
            window.speechSynthesis.cancel();
            window.speechSynthesis.stop();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR';
            utterance.rate = 0.8;
            utterance.pitch = 1.1;
            utterance.volume = 1.0;

            utterance.onstart = () => {
                log('‚úÖ Web Speech API iniciado');
            };

            utterance.onend = () => {
                log('‚úÖ Web Speech API terminou');
                isSpeaking = false;
                updateStatus('Pronto');
            };

            utterance.onerror = (event) => {
                log('‚ùå Erro no Web Speech API: ' + event.error);
                isSpeaking = false;
                updateStatus('Erro');
            };

            window.speechSynthesis.speak(utterance);
        }

        function limparLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Inicializa√ß√£o
        log('üöÄ Teste de Voz √önica iniciado');
        log('üìã Instru√ß√µes:');
        log('1. Clique em "Testar Google TTS" para testar a voz premium');
        log('2. Clique em "Testar Web Speech" para testar a voz gratuita');
        log('3. Use "Parar Todas" para interromper qualquer voz');
        log('4. Observe os logs para verificar se h√° apenas uma voz por vez');
    </script>
</body>
</html>
